!function(e){"use strict";var t={availableDates:[],flatpickrInstance:null,selectedDate:null,isLoading:!1,init:function(){"undefined"!=typeof flatpickr&&(this.showLoadingState(),this.loadAvailableDates(),this.bindEvents())},loadAvailableDates:function(){var t=this;e.ajax({url:wcCollectionDate.restUrl+"/dates",method:"GET",beforeSend:function(e){e.setRequestHeader("X-WP-Nonce",wcCollectionDate.restNonce)},success:function(e){e.success&&e.dates&&e.dates.length>0?(t.availableDates=e.dates,t.initializeDatePicker()):t.showError(wcCollectionDate.i18n.noDate||"No collection dates available","no_dates")},error:function(e,a,o){t.showError(wcCollectionDate.i18n.noDate||"Failed to load collection dates","api_error")}})},initializeDatePicker:function(){var t=this,a=document.getElementById("collection_date");a&&(this.flatpickrInstance&&this.flatpickrInstance.destroy(),this.availableDates.map(function(e){return new Date(e+"T00:00:00")}),this.flatpickrInstance=flatpickr(a,{inline:!0,dateFormat:"Y-m-d",minDate:this.availableDates[0],maxDate:this.availableDates[this.availableDates.length-1],defaultDate:this.availableDates[0],disableMobile:!1,allowInput:!1,static:!0,monthSelectorType:"dropdown",locale:{firstDayOfWeek:1},showMonths:1,disable:[function(e){var a=e.getFullYear()+"-"+String(e.getMonth()+1).padStart(2,"0")+"-"+String(e.getDate()).padStart(2,"0");return!(-1!==t.availableDates.indexOf(a))}],onReady:function(a,o,n){if(n.calendarContainer.classList.add("wc-collection-date-calendar"),t.hideLoadingState(),n.jumpToDate(t.availableDates[0]),!t.selectedDate&&t.availableDates.length>0){t.selectedDate=t.availableDates[0];var i=e("form.wc-block-checkout__form, form.checkout");i.length>0&&(i.find('input[name="wc_collection_date"]').remove(),i.append('<input type="hidden" name="wc_collection_date" value="'+t.selectedDate+'" />'))}},onChange:function(e,a,o){t.onDateChange(a)},onMonthChange:function(e,t,a){},onYearChange:function(e,t,a){}}),e(a).prop("readonly",!1),e(a).closest(".wc-collection-date-wrapper").addClass("initialized"))},getFlatpickrFormat:function(){return wcCollectionDate.dateFormat||"Y-m-d"},onDateChange:function(t){this.selectedDate=t;var a=e("#collection_date");a.length>0&&(a.val(t),a.closest(".form-row").removeClass("woocommerce-invalid"),a.closest(".form-row").find(".woocommerce-error").remove());var o=e("form.wc-block-checkout__form, form.checkout");o.length>0&&(o.find('input[name="wc_collection_date"]').remove(),o.append('<input type="hidden" name="wc_collection_date" value="'+t+'" />')),e(document.body).trigger("update_checkout"),e(document.body).trigger("wc_collection_date_changed",[t])},showLoadingState:function(){this.isLoading=!0;var t=e(".wc-collection-date-wrapper");if(t.length){t.addClass("is-loading");var a=e('<div class="wc-collection-date-skeleton"><div class="skeleton-calendar"><div class="skeleton-header"></div><div class="skeleton-weekdays"></div><div class="skeleton-days"></div></div></div>');t.find(".wc-collection-date-skeleton").remove(),t.prepend(a)}},hideLoadingState:function(){this.isLoading=!1;var t=e(".wc-collection-date-wrapper");t.length&&(t.removeClass("is-loading"),t.find(".wc-collection-date-skeleton").fadeOut(200,function(){e(this).remove()}))},showError:function(t,a){var o=e(".wc-collection-date-wrapper");if(this.hideLoadingState(),o.length){o.find(".wc-collection-date-error").remove();var n='<div class="wc-collection-date-error">';n+="<strong>"+t+"</strong>","no_dates"===a?(n+='<p class="error-help">',n+=wcCollectionDate.i18n.errorHelp||"Please check your lead time settings or try again later.",n+="</p>"):"api_error"===a&&(n+='<p class="error-help">',n+="Unable to load available dates. Please refresh the page or contact support if the issue persists.",n+="</p>");var i=e(n+="</div>");o.append(i)}},bindEvents:function(){var a=this;e(document.body).on("updated_checkout",function(){e(".wc-collection-date-wrapper").hasClass("initialized")||a.loadAvailableDates()}),e(document.body).on("checkout_error",function(){var t=e("#collection_date_field");t.find(".woocommerce-error").length&&(e("html, body").animate({scrollTop:t.offset().top-100},500),e("#collection_date").trigger("focus"))}),e("#collection_date").on("keydown paste",function(e){return e.preventDefault(),!1});var o=function(){return!!(window.wp&&window.wp.hooks&&window.wp.hooks.addFilter)&&(wp.hooks.addFilter("woocommerce_store_api_validate_checkout","wc-collection-date",function(a){var o=t.selectedDate||e("#collection_date").val()||"";return o&&""!==o.trim()||a.push({message:wcCollectionDate.i18n.selectDate||"Please select a collection date",field:"collection_date"}),a}),wp.hooks.addFilter("woocommerce_store_api_checkout_data","wc-collection-date",function(a){var o=t.selectedDate||e("#collection_date").val()||"";return a.extensions||(a.extensions={}),a.extensions["wc-collection-date"]||(a.extensions["wc-collection-date"]={}),a.extensions["wc-collection-date"].collection_date=o,a}),!0)};if(!o())var n=0,i=setInterval(function(){n++,(o()||n>=10)&&clearInterval(i)},500);var c=window.fetch;window.fetch=function(){for(var e=arguments.length,a=new Array(e),o=0;o<e;o++)a[o]=arguments[o];var n=a[0],i=a[1];if(n&&n.includes("/wc/store/v1/checkout")&&i&&i.body&&t.selectedDate)try{var l=JSON.parse(i.body);l.extensions||(l.extensions={}),l.extensions["wc-collection-date"]||(l.extensions["wc-collection-date"]={}),l.extensions["wc-collection-date"].collection_date=t.selectedDate,i.body=JSON.stringify(l)}catch(e){}return c.apply(this,a)}},validateDate:function(e){return-1!==this.availableDates.indexOf(e)},getSelectedDate:function(){return this.selectedDate||e("#collection_date").val()}};e(document).ready(function(){"undefined"!=typeof wc_checkout_params?t.init():setTimeout(function(){t.init()},500)}),window.wcCollectionDatePicker=t}(jQuery);